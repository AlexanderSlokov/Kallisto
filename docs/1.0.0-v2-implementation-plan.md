# Phase 1 Implementation Plan: CNCF-Ready Infrastructure

> **Status**: ✅ APPROVED (2026-01-18)

## Goal

Transform Kallisto from a DSA prototype (single-threaded CLI) into a production-grade foundation ready for CNCF Sandbox submission.

---

## Approved Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Event Loop** | `epoll` (Linux-only) | Cloud-native focus, container-first. io_uring as future optimization |
| **Workers** | = CPU cores | Auto-detect via `std::thread::hardware_concurrency()`. Cgroup handles quota |
| **RocksDB** | ✅ Accepted | 1 dedicated thread for persistence, ~50MB binary overhead |
| **Stats** | Prometheus scrape | Pull-based, no dedicated stats thread needed |

---

## Thread Architecture (Finalized)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         KALLISTO PROCESS                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                     MAIN THREAD (1)                            │ │
│  │  • Initialize all components                                   │ │
│  │  • Spawn worker threads                                        │ │
│  │  • Config hot-reload                                           │ │
│  │  • Graceful shutdown coordination                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│         ┌────────────────────┼────────────────────┐                 │
│         ▼                    ▼                    ▼                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ WORKER 0    │     │ WORKER 1    │     │ WORKER N-1  │           │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤           │
│  │ Dispatcher  │     │ Dispatcher  │     │ Dispatcher  │           │
│  │ (epoll fd)  │     │ (epoll fd)  │     │ (epoll fd)  │           │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤           │
│  │ gRPC Handler│     │ gRPC Handler│     │ gRPC Handler│           │
│  │ PUT/GET/DEL │     │ PUT/GET/DEL │     │ PUT/GET/DEL │           │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤           │
│  │ TLS Stats   │     │ TLS Stats   │     │ TLS Stats   │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         └───────────────────┴───────────────────┘                   │
│                             │                                        │
│                             ▼ (shared access with RW locks)         │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    SHARED DATA LAYER                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │ │
│  │  │ CuckooTable  │  │ BTreeIndex   │  │ WriteBuffer  │         │ │
│  │  │ (RW Lock)    │  │ (RW Lock)    │  │ (lock-free Q)│         │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                             │                                        │
│                             ▼                                        │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │               PERSISTENCE THREAD (1)                           │ │
│  │  • Consume from WriteBuffer (lock-free queue)                  │ │
│  │  • Flush to RocksDB                                            │ │
│  │  • Trigger compaction                                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │               FUTURE: RAFT THREAD (Phase 2)                    │ │
│  │  • NuRaft event loop                                           │ │
│  │  • Leader election, log replication                            │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

Thread Count: Main(1) + Workers(N) + Persistence(1) = N + 2
Example (8-core): 1 + 8 + 1 = 10 threads
```

---

## Implementation Order

### Phase 1.1: Threading Infrastructure (Priority 1)

#### [NEW] [dispatcher.hpp](file:///workspaces/kallisto/include/kallisto/event/dispatcher.hpp)

epoll-based event loop:

```cpp
namespace kallisto::event {

class Dispatcher {
public:
    virtual ~Dispatcher() = default;
    
    // Core event loop (blocks on epoll_wait)
    virtual void run() = 0;
    virtual void exit() = 0;
    
    // Thread-safe task posting (lock-free MPSC queue)
    using PostCb = std::function<void()>;
    virtual void post(PostCb callback) = 0;
    
    // Timer creation (via timerfd)
    virtual TimerPtr createTimer(std::function<void()> cb) = 0;
    
    // File descriptor watching
    virtual void addFd(int fd, uint32_t events, std::function<void(uint32_t)> cb) = 0;
    virtual void removeFd(int fd) = 0;
    
    // Thread safety
    virtual bool isThreadSafe() const = 0;
    virtual const std::string& name() const = 0;
};

} // namespace kallisto::event
```

---

#### [NEW] [worker.hpp](file:///workspaces/kallisto/include/kallisto/event/worker.hpp)

```cpp
namespace kallisto::event {

class Worker {
public:
    virtual ~Worker() = default;
    
    // Lifecycle
    virtual void start(std::function<void()> on_ready) = 0;
    virtual void stop() = 0;
    
    // Dispatcher access
    virtual Dispatcher& dispatcher() = 0;
    
    // TLS Stats (zero-lock read)
    virtual uint64_t requestsProcessed() const = 0;
    virtual uint64_t requestLatencyP99Us() const = 0;
};

class WorkerFactory {
public:
    virtual ~WorkerFactory() = default;
    virtual std::unique_ptr<Worker> createWorker(
        uint32_t index, 
        const std::string& name_prefix
    ) = 0;
};

} // namespace kallisto::event
```

---

#### [NEW] [thread_local.hpp](file:///workspaces/kallisto/include/kallisto/thread_local/thread_local.hpp)

```cpp
namespace kallisto::thread_local {

// Thread-local object base
class ThreadLocalObject {
public:
    virtual ~ThreadLocalObject() = default;
};

class Slot {
public:
    template<typename T>
    T& getTyped();
    
    void set(std::function<std::shared_ptr<ThreadLocalObject>()> initializer);
};

class Instance {
public:
    std::unique_ptr<Slot> allocateSlot();
    void registerThread(event::Dispatcher& dispatcher, bool is_main);
    void shutdownThread();
    void shutdownGlobalThreading();
};

} // namespace kallisto::thread_local
```

---

### Phase 1.2: Persistence Thread + RocksDB

#### [NEW] [persistence_thread.hpp](file:///workspaces/kallisto/include/kallisto/persistence/persistence_thread.hpp)

```cpp
namespace kallisto::persistence {

struct WriteOp {
    enum class Type { PUT, DELETE };
    Type type;
    std::string key;
    std::string value;  // empty for DELETE
};

class PersistenceThread {
public:
    PersistenceThread(std::unique_ptr<StorageBackend> backend);
    
    void start();
    void stop();
    
    // Called by workers (lock-free enqueue)
    void enqueue(WriteOp op);
    
private:
    void threadLoop();
    
    std::unique_ptr<StorageBackend> backend_;
    MPSCQueue<WriteOp> write_queue_;  // Lock-free multi-producer single-consumer
    std::thread thread_;
    std::atomic<bool> running_{false};
};

} // namespace kallisto::persistence
```

---

#### [NEW] [rocksdb_backend.hpp](file:///workspaces/kallisto/include/kallisto/storage/rocksdb_backend.hpp)

```cpp
namespace kallisto::storage {

class RocksDBBackend : public StorageBackend {
public:
    explicit RocksDBBackend(const std::string& db_path);
    ~RocksDBBackend() override;
    
    bool put(const std::string& key, const std::string& value) override;
    std::optional<std::string> get(const std::string& key) override;
    bool remove(const std::string& key) override;
    
    // Batch for efficiency
    void writeBatch(const std::vector<WriteOp>& ops);
    
private:
    std::unique_ptr<rocksdb::DB> db_;
};

} // namespace kallisto::storage
```

---

### Phase 1.3: gRPC API (After Threading Works)

#### [NEW] [kallisto.proto](file:///workspaces/kallisto/proto/kallisto.proto)

```protobuf
syntax = "proto3";
package kallisto.v1;

service Kallisto {
    rpc Put(PutRequest) returns (PutResponse);
    rpc Get(GetRequest) returns (GetResponse);
    rpc Delete(DeleteRequest) returns (DeleteResponse);
    rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message PutRequest {
    string path = 1;
    string key = 2;
    bytes value = 3;  // bytes for binary secrets
}

message PutResponse {
    bool success = 1;
    string error = 2;
}

message GetRequest {
    string path = 1;
    string key = 2;
}

message GetResponse {
    bool found = 1;
    bytes value = 2;
}

message DeleteRequest {
    string path = 1;
    string key = 2;
}

message DeleteResponse {
    bool success = 1;
}

message HealthCheckRequest {}

message HealthCheckResponse {
    enum Status {
        UNKNOWN = 0;
        SERVING = 1;
        NOT_SERVING = 2;
    }
    Status status = 1;
}
```

---

## Files Summary

| Action | Path | Phase |
|--------|------|-------|
| NEW | `include/kallisto/event/dispatcher.hpp` | 1.1 |
| NEW | `include/kallisto/event/worker.hpp` | 1.1 |
| NEW | `src/event/dispatcher_impl.cpp` | 1.1 |
| NEW | `src/event/worker_impl.cpp` | 1.1 |
| NEW | `include/kallisto/thread_local/thread_local.hpp` | 1.1 |
| NEW | `src/thread_local/thread_local_impl.cpp` | 1.1 |
| NEW | `include/kallisto/persistence/persistence_thread.hpp` | 1.2 |
| NEW | `src/persistence/persistence_thread.cpp` | 1.2 |
| NEW | `include/kallisto/storage/rocksdb_backend.hpp` | 1.2 |
| NEW | `src/storage/rocksdb_backend.cpp` | 1.2 |
| NEW | `proto/kallisto.proto` | 1.3 |
| NEW | `src/grpc/grpc_server.cpp` | 1.3 |
| MODIFY | `include/kallisto/kallisto.hpp` | 1.1 |
| MODIFY | `src/kallisto.cpp` | 1.1 |
| MODIFY | `CMakeLists.txt` | 1.1 |

---

## Verification Plan

| Test | Command | Checkpoint |
|------|---------|------------|
| Existing tests | `make test` | No regressions |
| Thread safety | `make test-atomic` | No segfaults |
| Throughput | `make benchmark-batch` | >100k RPS |
| P99 latency | `make benchmark-p99` | <1ms |
| Multi-worker | `./kallisto --workers=4` | Linear scaling |

---

## Future Optimizations (Post Phase 1)

1. **io_uring backend** - Replace epoll for higher throughput
2. **SIMD tag search** - AVX2 for 8-slot bucket search in CuckooTable
3. **NuRaft integration** - Consensus for HA (Phase 2)
